<div class="modal-header" data-bs-theme="ligth">
  <h1 class="modal-title fs-5">Ajouter projet</h1>
  <button type="button" class="btn-close" aria-label="Close" (click)="activeModal.close()"></button>
</div>
<div class="modal-body">
  <form [formGroup]="reactiveForm_add_projet" (ngSubmit)="onSubmit_add_projet()" #form_add_projet="ngForm" enctype="multipart/form-data">
    <fieldset class="row fieldset-custom">
      <legend class="text-secondary">Projet</legend>
      <!-- Champ Nom -->
      <div class="form-group col-sm-8">
        <label>Nom <span class="text-danger">*</span></label>
        <input class="form-control" type="text" formControlName="nom" placeholder="Nom"
          [ngClass]="{ 'is-invalid': submitted && f.nom.errors }" />
        @if (submitted && f.nom.errors) {
        <div class="invalid-feedback">
          @if (f.nom.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>
      <!-- Champ code_projet -->
      <div class="form-group col-sm-4">
        <label>Code projet <span class="text-danger">*</span></label>
        <input class="form-control" type="text" formControlName="code_projet" placeholder="Code Projet"
          [ngClass]="{ 'is-invalid': submitted && f.code_projet.errors }" />
        @if (submitted && f.code_projet.errors) {
        <div class="invalid-feedback">
          @if (f.code_projet.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>
      <!-- Champ Id Cellule (Clé étrangère vers cellule) -->
      <div class="form-group col-sm-6">
        <label>Cellule <span class="text-danger">*</span></label>
        <select [ngClass]="{ 'is-invalid': submitted && f.id_cellule.errors }" class="form-select"
          formControlName="id_cellule">
          <option value="">Sélectionnez un(e) Cellule</option>
          @for (one_cellule of form_details?.les_cellules; track $index) {
          <option [value]="one_cellule.id_cellule">
            {{ one_cellule.nom_cellule}}
          </option>
          }
        </select>
        @if (submitted && f.id_cellule.errors) {
        <div class="invalid-feedback">
          @if (f.id_cellule.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>
      <!-- Champ Id Client (Clé étrangère vers client) -->
      <div class="form-group col-sm-6">
        <label>Client <span class="text-danger">*</span></label>
        <select [ngClass]="{ 'is-invalid': submitted && f.id_client.errors }" class="form-select"
          formControlName="id_client">
          <option value="">Sélectionnez un(e) Client</option>
          @for (one_client of form_details?.les_clients; track $index) {
          <option [value]="one_client.id_client">
            {{ one_client.nom }}
          </option>
          }
        </select>
        @if (submitted && f.id_client.errors) {
        <div class="invalid-feedback">
          @if (f.id_client.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>
      <!-- Champ Condition Facture -->
      <div class="form-group col-sm-6">
        <label>Condition Facturation (En mois) <span class="text-danger">*</span></label>
        <input class="form-control" type="text" formControlName="condition_facture" placeholder="Condition Facture"
          [ngClass]="{ 'is-invalid': submitted && f.condition_facture.errors }" />
        @if (submitted && f.condition_facture.errors) {
        <div class="invalid-feedback">
          @if (f.condition_facture.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>

      <!-- Champ Delais Reglement Facture -->
      <div class="form-group col-sm-6">
        <label>Delais Reglement Facture (En jour)<span class="text-danger">*</span></label>
        <input class="form-control" type="text" formControlName="delais_reglement_facture"
          placeholder="Delais Reglement Facture"
          [ngClass]="{ 'is-invalid': submitted && f.delais_reglement_facture.errors }" />
        @if (submitted && f.delais_reglement_facture.errors) {
        <div class="invalid-feedback">
          @if (f.delais_reglement_facture.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>

      <!-- Champ Id type_remuneration (Clé étrangère vers type_remuneration) -->
      <div class="form-group col-sm-12">
        <label>Type Rémunération <span class="text-danger">*</span></label>
        <select [ngClass]="{ 'is-invalid': submitted && f.type_remuneration.errors }" class="form-select"
          formControlName="type_remuneration">
          <option value="">Sélectionnez un(e) type remuneration</option>
          @for (one_type_remuneration of les_types_remuneration; track $index) {
          <option [value]="one_type_remuneration">
            {{ one_type_remuneration }}
          </option>
          }
        </select>
        @if (submitted && f.type_remuneration.errors) {
        <div class="invalid-feedback">
          @if (f.type_remuneration.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>

      <!-- Paretanire -->
      <fieldset class="row fieldset-custom">
        <legend class="text-secondary">Partenaire</legend>
        <tr>
          <div class="text-center" *ngIf="f.les_partenaires.controls.length == 0">
            <button class="btn btn-primary" type="button" (click)="onAddForm()">
              <i class="bi bi-plus-square-dotted me-1"></i> Ajouter un partenaire
            </button>
          </div>
          <ng-container formArrayName="les_partenaires">
            <ng-container
              *ngFor="let one_detail_control of f.les_partenaires.controls; let i = index; let un = first; let last = last"
              [formGroupName]="i">
              <div class="row">
                <div class="form-group col-sm-8">
                  <label>Partenaire <span class="text-danger">*</span></label>
                  <select [ngClass]="{ 'is-invalid': submitted && one_detail_control.controls.id_partenaire.errors }"
                    class="form-select" formControlName="id_partenaire">
                    <option value="">Sélectionnez un(e) Partenaire</option>
                    @for (one_partenaire of form_details?.les_partenaires; track $index) {
                    <option [value]="one_partenaire.id_partenaire"
                      [disabled]="api.is_already_selected(one_partenaire.id_partenaire,f?.les_partenaires.value,'id_partenaire')==one_partenaire.id_partenaire">
                      {{ one_partenaire.nom_partenaire }}
                    </option>
                    }
                  </select>
                  @if (submitted && one_detail_control.controls.id_partenaire.errors) {
                  <div class="invalid-feedback">
                    @if (one_detail_control.controls.id_partenaire.errors.required) {
                    <div>Ce champ est obligatoire</div>
                    }
                  </div>
                  }
                </div>
                <!-- Champ Fichier Contrat -->
                <div class="form-group col-sm-3">
                  <label>Pourcentage Partenaire (%) <span class="text-danger">*</span></label>
                  <input class="form-control" type="text" formControlName="pourcentage_partenaire" placeholder="20"
                    [ngClass]="{ 'is-invalid': submitted && one_detail_control.controls.pourcentage_partenaire.errors }" />
                  @if (submitted && one_detail_control.controls.pourcentage_partenaire.errors) {
                  <div class="invalid-feedback">
                    @if (one_detail_control.controls.pourcentage_partenaire.errors.required) {
                    <div>Ce champ est obligatoire</div>
                    }
                  </div>
                  }
                  @if (submitted && one_detail_control.controls.pourcentage_partenaire.errors) {
                  <div class="invalid-feedback">
                    @if (one_detail_control.controls.pourcentage_partenaire.errors.pattern) {
                    <div>Que des chiffres</div>
                    }
                  </div>
                  }
                </div>
                <div class=" d-flex justify-content-center align-items-center col-sm-1 ">
                  <button class="btn btn-outline-primary" type="button" (click)="onRemoveForm(i)"><i
                      class="bi bi-trash3-fill"></i> </button>
                </div>
              </div>
            </ng-container>
          </ng-container>
          <div class="text-center" *ngIf="f.les_partenaires.controls.length !== 0">
            <button class="btn btn-primary" type="button" (click)="onAddForm()">
              <i class="bi bi-plus-square-dotted"></i>
            </button>
          </div>

          <!-- @if (is_partenaire) { -->
          <!-- Champ Id Bailleur (Clé étrangère vers bailleur) -->
          <!-- <div class=" d-flex justify-content-center align-items-center col-sm-2 ">
          <button class="btn btn-outline-primary" type="button" (click)="switch_is_partenaire()"><i
              class="bi bi-trash3-fill"></i> </button>
        </div> -->
          <!-- }@else {
        <div class="text-center">
          <button class="btn btn-outline-primary w-25" type="button" (click)="switch_is_partenaire()"><i
              class="bi bi-plus-square-dotted"></i> Partenaire</button>
        </div>
        } -->
      </fieldset>
    </fieldset>

    <!-- base -->
    <fieldset class="row fieldset-custom">
      <legend class="text-secondary">Base</legend>
      <!-- Champ Numero Contrat -->
      <div class="form-group col-sm-3">
        <label>Numero Contrat <span class="text-danger">*</span></label>
        <input class="form-control" type="text" formControlName="numero_contrat" placeholder="Numero Contrat"
          [ngClass]="{ 'is-invalid': submitted && f.numero_contrat.errors }" />
        @if (submitted && f.numero_contrat.errors) {
        <div class="invalid-feedback">
          @if (f.numero_contrat.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>

      <!-- Champ Montant Base -->
      <div class="form-group col-sm-3">
        <label>Montant <span class="text-danger">*</span></label>
        <input class="form-control" type="text" formControlName="montant" placeholder="Montant"
          [ngClass]="{ 'is-invalid': submitted && f.montant.errors }" />
        @if (submitted && f.montant.errors) {
        <div class="invalid-feedback">
          @if (f.montant.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>

      <!-- Champ Ordre Service -->
      <div class="form-group col-sm-3">
        <label>Ordre Service <span class="text-danger">*</span></label>
        <input class="form-control" type="date" formControlName="ordre_service" placeholder="Ordre Service"
          [ngClass]="{ 'is-invalid': submitted && f.ordre_service.errors }" [max]="f.date_fin.value"/>
        @if (submitted && f.ordre_service.errors) {
        <div class="invalid-feedback">
          @if (f.ordre_service.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>

      <!-- Champ Date Fin Contrat -->
      <div class="form-group col-sm-3">
        <label>Date Fin Contrat <span class="text-danger">*</span></label>
        <input class="form-control" type="date" formControlName="date_fin" placeholder="Date Fin Contrat"
          [ngClass]="{ 'is-invalid': submitted && f.date_fin.errors }" [min]="f.ordre_service.value"/>
        @if (submitted && f.date_fin.errors) {
        <div class="invalid-feedback">
          @if (f.date_fin.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>

      <!-- Champ Id Bailleur (Clé étrangère vers bailleur) -->
      <div class="form-group col-sm-3">
        <label>Bailleur <span class="text-danger">*</span></label>
        <select [ngClass]="{ 'is-invalid': submitted && f.id_bailleur.errors }" class="form-select"
          formControlName="id_bailleur">
          <option value="">Sélectionnez un(e) Bailleur</option>
          @for (one_bailleur of form_details?.les_bailleurs; track $index) {
          <option [value]="one_bailleur.id_bailleur">
            {{ one_bailleur.nom_bailleur }}
          </option>
          }
        </select>
        @if (submitted && f.id_bailleur.errors) {
        <div class="invalid-feedback">
          @if (f.id_bailleur.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>
      <!-- Champ Date Expiration Avd -->
      <div class="form-group col-sm-3">
        <label>Date Expiration Caution</label>
        <input class="form-control" type="date" formControlName="date_expiration_avd" placeholder="Date Expiration Avd"
          [ngClass]="{ 'is-invalid': submitted && f.date_expiration_avd.errors }" />
        @if (submitted && f.date_expiration_avd.errors) {
        <div class="invalid-feedback">
          @if (f.date_expiration_avd.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>

      <!-- Champ Reference Caution -->
      <div class="form-group col-sm-3">
        <label>Numéro Caution </label>
        <input class="form-control" type="text" formControlName="numero_caution" placeholder="Numéro Caution"
          [ngClass]="{ 'is-invalid': submitted && f.numero_caution.errors }" />
        @if (submitted && f.numero_caution.errors) {
        <div class="invalid-feedback">
          @if (f.numero_caution.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>
      <!-- Champ Pourcentage Avd -->
      <div class="form-group col-sm-3">
        <label>Pourcentage Avd </label>
        <input class="form-control" type="text" formControlName="pourcentage_avd" placeholder="Pourcentage Avd"
          [ngClass]="{ 'is-invalid': submitted && f.pourcentage_avd.errors }" />
        @if (submitted && f.pourcentage_avd.errors) {
        <div class="invalid-feedback">
          @if (f.pourcentage_avd.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>

      <!-- Champs Id Etat avenant avec un contrôle de validité : clé étrangère liée à la colonne id_etat_avenant de la table etat_avenant -->
      <div class="form-group col-sm-12">
        <label>Etat Base <span class="text-danger">*</span></label>
        <select [ngClass]="{ 'is-invalid': submitted && f.id_etat_avenant.errors }" class="form-select"
          formControlName="id_etat_avenant">
          <option value="">Sélectionnez un(e) Etat avenant</option>
          @for (one_etat_avenant of form_details?.les_etat_avenants; track $index) {
          <option [value]="one_etat_avenant.id_etat_avenant">
            {{ one_etat_avenant.nom}}
          </option>
          }
        </select>
        @if (submitted && f.id_etat_avenant.errors) {
        <div class="invalid-feedback">
          @if (f.id_etat_avenant.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>

      <!-- Champ Fichier Contrat -->
      <div class="form-group col-sm-12">
        <label>Fichier Contrat</label>
        <input class="form-control" type="file" formControlName="fichier_contrat" placeholder="Fichier Contrat"
          [ngClass]="{ 'is-invalid': submitted && f.fichier_contrat.errors }" (change)="on_file_selected($event)" name="fichier_contrat" multiple />
        @if (submitted && f.fichier_contrat.errors) {
        <div class="invalid-feedback">
          @if (f.fichier_contrat.errors.required) {
          <div>Ce champ est obligatoire</div>
          }
        </div>
        }
      </div>
    </fieldset>
  </form>
</div>
<div class="modal-footer">
  <button type="button" class="btn btn-primary m-2"
    [disabled]="loading_add_projet || loading_get_details_add_projet_form" (click)="form_add_projet.ngSubmit.emit()">
    {{ loading_add_projet ? "En cours ..." : "Valider" }}
  </button>
  <button type="button" class="btn btn-outline-danger" (click)="activeModal.close()">Fermer</button>
</div>
